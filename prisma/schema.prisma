// Prisma schema for Sotuv bolimi (improved from Uzvideohub)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  tgId         String?   @unique // telegram user id (optional until mini-app auth)
  phone        String?   @unique
  username     String?   @unique
  displayName  String?
  coins        Int       @default(0)
  role         Role      @default(USER)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  purchases    Purchase[]
}

model Video {
  id           String    @id @default(cuid())
  code         String?   @unique // optional internal short code
  title        String
  description  String
  // You can store original URL (Yandex/Cloud/Telegram CDN) and proxied url
  sourceUrl    String
  thumbUrl     String?
  category     String?
  tags         String[]  @default([])
  isFree       Boolean   @default(false)
  price        Int       @default(0) // in coins or smallest currency unit (e.g. tiyins)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  purchases    Purchase[]
}

model Purchase {
  id          String    @id @default(cuid())
  userId      String
  videoId     String
  amountPaid  Int       @default(0)
  currency    String?   // "UZS" or "COIN"
  status      PurchaseStatus @default(SUCCESS)
  createdAt   DateTime  @default(now())

  user        User      @relation(fields: [userId], references: [id])
  video       Video     @relation(fields: [videoId], references: [id])

  @@unique([userId, videoId]) // one user buys a video once
}

enum Role {
  USER
  ADMIN
}

enum PurchaseStatus {
  SUCCESS
  REFUNDED
  FAILED
}
