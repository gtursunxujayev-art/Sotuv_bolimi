generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  tgId         String?   @unique
  phone        String?   @unique
  username     String?   @unique
  displayName  String?
  coins        Int       @default(0)
  role         Role      @default(USER)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  purchases    Purchase[]
  coinTxs      CoinTransaction[]  @relation("UserCoinTxs")
}

model Video {
  id           String    @id @default(cuid())
  code         String?   @unique
  title        String
  description  String
  sourceUrl    String
  thumbUrl     String?
  category     String?
  tags         String[]  @default([])
  isFree       Boolean   @default(false)
  price        Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  purchases    Purchase[]
}

model Purchase {
  id          String          @id @default(cuid())
  userId      String
  videoId     String
  amountPaid  Int             @default(0)
  currency    String?
  status      PurchaseStatus  @default(SUCCESS)
  createdAt   DateTime        @default(now())

  user        User            @relation(fields: [userId], references: [id])
  video       Video           @relation(fields: [videoId], references: [id])

  @@unique([userId, videoId])
  @@index([userId, createdAt])
  @@index([videoId, createdAt])
}

model CoinTransaction {
  id        String     @id @default(cuid())
  userId    String
  amount    Int        // positive = grant, negative = deduct/spend
  type      CoinTxType
  note      String?
  createdAt DateTime   @default(now())

  user      User       @relation("UserCoinTxs", fields: [userId], references: [id])

  @@index([userId, createdAt])
}

enum Role {
  USER
  ADMIN
}

enum PurchaseStatus {
  SUCCESS
  REFUNDED
  FAILED
}

enum CoinTxType {
  GRANT     // admin adds coins
  DEDUCT    // admin removes coins
  PURCHASE  // user spends coins to buy a video
  REFUND    // coins returned
}
